## GitHub Actions CI/CD Support

The deployment scripts must support BOTH local interactive deployment AND automated CI/CD via GitHub Actions.

### CI/CD Detection

The PowerShell deployment script (`deploy-infra/deploy.ps1`) must detect when running in CI/CD:

```powershell
$IsCI = $env:GITHUB_ACTIONS -eq "true" -or $env:TF_BUILD -eq "true" -or $env:CI -eq "true"
```

### Authentication Differences

**Local (Interactive) Mode:**
- Use `az ad signed-in-user show` to get the current user's Object ID and UPN
- Set `adminPrincipalType = "User"` for SQL Server admin
- Use `--authentication-method=ActiveDirectoryDefault` for sqlcmd

**CI/CD Mode (GitHub Actions with OIDC):**
- Use `$env:AZURE_CLIENT_ID` to get the Service Principal's Application ID
- Use `az ad sp show --id $servicePrincipalClientId` to get the SP's Object ID and display name
- Set `adminPrincipalType = "Application"` for SQL Server admin
- Use `--authentication-method=ActiveDirectoryAzCli` for sqlcmd (NOT ActiveDirectoryDefault)
- Never call `az ad signed-in-user show` - it will fail with OIDC authentication

### sqlcmd Authentication in CI/CD

**IMPORTANT:** In CI/CD with OIDC, sqlcmd must use `ActiveDirectoryAzCli` authentication:

```powershell
$authMethod = if ($IsCI) { "ActiveDirectoryAzCli" } else { "ActiveDirectoryDefault" }
sqlcmd -S $serverFqdn -d "Northwind" "--authentication-method=$authMethod" -i $schemaFile
```

`ActiveDirectoryDefault` fails in OIDC because it tries `EnvironmentCredential` first, which sees `AZURE_CLIENT_ID` and `AZURE_TENANT_ID` but no `AZURE_CLIENT_SECRET`, causing "Identity not found" errors.

### Managed Identity Database User Creation (SID-based)

**IMPORTANT:** Do NOT use `CREATE USER ... FROM EXTERNAL PROVIDER` as it requires SQL Server to have Directory Reader permissions in Entra ID.

Instead, use SID-based user creation by converting the Managed Identity's Client ID to a SID:

```powershell
# Convert Client ID (GUID) to SID hex format
$guidBytes = [System.Guid]::Parse($managedIdentityClientId).ToByteArray()
$sidHex = "0x" + [System.BitConverter]::ToString($guidBytes).Replace("-", "")

# Create user with SID (no Directory Reader required)
$createUserSql = @"
IF EXISTS (SELECT * FROM sys.database_principals WHERE name = '$managedIdentityName')
    DROP USER [$managedIdentityName];

CREATE USER [$managedIdentityName] WITH SID = $sidHex, TYPE = E;

ALTER ROLE db_datareader ADD MEMBER [$managedIdentityName];
ALTER ROLE db_datawriter ADD MEMBER [$managedIdentityName];
GRANT EXECUTE TO [$managedIdentityName];
"@
```

### Bicep Parameter Support

The `azure-sql.bicep` module must accept an `adminPrincipalType` parameter:

```bicep
@allowed(['User', 'Application'])
param adminPrincipalType string = 'User'
```

And use it in the SQL Server administrators configuration:

```bicep
principalType: adminPrincipalType
```

The `main.bicep` must pass this parameter through from the deployment script.

### GitHub Actions Workflow

A workflow file at `.github/workflows/deploy.yml` should:

1. Use OIDC federation for authentication (no secrets):
   ```yaml
   permissions:
     id-token: write
     contents: read
   ```

2. Use `azure/login@v2` with OIDC:
   ```yaml
   - uses: azure/login@v2
     with:
       client-id: ${{ vars.AZURE_CLIENT_ID }}
       tenant-id: ${{ vars.AZURE_TENANT_ID }}
       subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
   ```

3. Install go-sqlcmd directly from GitHub releases (not apt repository - Ubuntu 24.04 apt-key is deprecated):
   ```yaml
   - run: |
       curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
       sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
   ```

4. Add a delay between infrastructure and application deployment to avoid SCM restart conflicts:
   ```yaml
   - name: Wait for App Service to stabilize
     run: |
       echo "Waiting 60 seconds for App Service settings to apply..."
       sleep 60
   ```

5. Call the same PowerShell deployment scripts used locally

### Setup Documentation

Include a `.github/CICD-SETUP.md` file with PowerShell instructions for:

1. Creating a Service Principal with OIDC federation
2. Assigning **Contributor** role to the subscription (for creating/managing resources)
3. Assigning **User Access Administrator** role to the subscription (required for creating role assignments, e.g., giving Managed Identity access to Azure OpenAI)
4. Creating federated credentials for the repository
5. Configuring GitHub repository variables (AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID)

### Required Azure Roles for Service Principal

The Service Principal needs TWO roles at the subscription level:

| Role | Purpose |
|------|---------|
| **Contributor** | Create and manage Azure resources (App Service, SQL, OpenAI, etc.) |
| **User Access Administrator** | Create role assignments (required when Bicep assigns Managed Identity access to resources like Azure OpenAI) |

Without User Access Administrator, deployments that include role assignments in Bicep will fail with:
> "The client does not have permission to perform action 'Microsoft.Authorization/roleAssignments/write'"
