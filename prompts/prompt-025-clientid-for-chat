## AZURE_CLIENT_ID and ManagedIdentityClientId Configuration

The App Service requires critical settings for managed identity authentication.

### 1. AZURE_CLIENT_ID Environment Variable

This setting tells DefaultAzureCredential which managed identity to use when multiple identities are available:

    az webapp config appsettings set --name <app-name> --resource-group <rg-name> --settings "AZURE_CLIENT_ID=<managed-identity-client-id>"

This is needed because:

- The App Service uses a user-assigned managed identity (not system-assigned)
- DefaultAzureCredential needs to know which managed identity to use
- Without this setting, you get: "Unable to load the proper Managed Identity"

### 2. ManagedIdentityClientId for GenAI Services

The chat service uses ManagedIdentityCredential with explicit client ID for Azure OpenAI authentication:

```csharp
var managedIdentityClientId = _configuration["ManagedIdentityClientId"];
Azure.Core.TokenCredential credential;

if (!string.IsNullOrEmpty(managedIdentityClientId))
{
    _logger.LogInformation("Using ManagedIdentityCredential with client ID: {ClientId}", managedIdentityClientId);
    credential = new ManagedIdentityCredential(managedIdentityClientId);
}
else
{
    _logger.LogInformation("Using DefaultAzureCredential");
    credential = new DefaultAzureCredential();
}
```

### 3. ConnectionStrings__DefaultConnection

The SQL connection string MUST be configured in App Service settings with the Managed Identity authentication format:

    Server=tcp:{server}.database.windows.net,1433;Initial Catalog=Northwind;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;Authentication=Active Directory Managed Identity;User Id={managedIdentityClientId};

Note: The `User Id` in the connection string must be the managed identity CLIENT ID, not the principal ID.

### Critical Deployment Requirement

All three settings (AZURE_CLIENT_ID, ManagedIdentityClientId, ConnectionStrings__DefaultConnection) MUST be configured during infrastructure deployment, not just application deployment. The infrastructure deployment script (deploy-infra/deploy.ps1) handles this automatically.

### Pass Managed Identity to GenAI Module

In main.bicep, pass appService.outputs.managedIdentityPrincipalId to the genai module for role assignments:

- Accept managedIdentityPrincipalId as a parameter in genai.bicep
- Use this principal ID for role assignments to Azure OpenAI and Cognitive Search
- Do not create a new managed identity in genai.bicep
