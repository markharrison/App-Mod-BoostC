@page
@model ChatModel
@{
    ViewData["Title"] = "AI Chat";
    ViewData["ErrorMessage"] = Model.ErrorMessage;
    ViewData["ErrorLocation"] = Model.ErrorLocation;
}

<div class="row mb-4">
    <div class="col-12">
        <h1 class="mb-3"><i class="bi bi-chat-dots me-2"></i>AI Assistant</h1>
        <p class="text-muted">Ask questions about your expenses or request actions using natural language.</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card" style="height: 600px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-robot me-2"></i>Chat</span>
                <span id="genai-status" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body d-flex flex-column p-0">
                <div id="chat-messages" class="flex-grow-1 overflow-auto p-3" style="background-color: #f8fafc;">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-square-dots fs-1 d-block mb-3"></i>
                        <p>Start a conversation with the AI assistant</p>
                    </div>
                </div>
                <div class="border-top p-3">
                    <form id="chat-form" class="d-flex gap-2">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off">
                        <button type="submit" class="btn btn-primary" id="send-btn">
                            <i class="bi bi-send"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>Example Queries
            </div>
            <div class="card-body">
                <p class="text-muted small">Click on any example to try it:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="Show me all expenses">
                        <i class="bi bi-list-ul me-2"></i>Show me all expenses
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="What expenses are pending approval?">
                        <i class="bi bi-hourglass me-2"></i>What expenses are pending approval?
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="Create a travel expense for £50 dated today for taxi fare">
                        <i class="bi bi-plus-circle me-2"></i>Create a travel expense for £50
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="Show expense summary by status">
                        <i class="bi bi-pie-chart me-2"></i>Show expense summary by status
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="List all expense categories">
                        <i class="bi bi-tags me-2"></i>List all expense categories
                    </button>
                    <button class="btn btn-outline-secondary btn-sm text-start example-query" data-query="Show expenses by category">
                        <i class="bi bi-bar-chart me-2"></i>Show expenses by category
                    </button>
                </div>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>About
            </div>
            <div class="card-body">
                <p class="small text-muted">
                    This AI assistant uses Azure OpenAI to help you manage expenses through natural language.
                </p>
                <p class="small text-muted mb-0">
                    <strong>Available actions:</strong> View expenses, create new expenses, submit for approval, approve/reject expenses, get summaries.
                </p>
            </div>
        </div>
    </div>
</div>

<style>
    .chat-message {
        max-width: 80%;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }
    .chat-message.user {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    .chat-message.assistant {
        background: white;
        border: 1px solid #e2e8f0;
        margin-right: auto;
        border-bottom-left-radius: 0.25rem;
    }
    .chat-message.assistant ul, .chat-message.assistant ol {
        margin-bottom: 0;
        padding-left: 1.25rem;
    }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 0.75rem 1rem;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #94a3b8;
        border-radius: 50%;
        animation: typing 1.4s ease-in-out infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @@keyframes typing {
        0%, 100% { opacity: 0.4; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1); }
    }
</style>

@section Scripts {
<script>
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const genaiStatus = document.getElementById('genai-status');
    let conversationHistory = [];

    // Check GenAI status
    fetch('/api/chat/status')
        .then(r => r.json())
        .then(data => {
            if (data.enabled) {
                genaiStatus.className = 'badge bg-success';
                genaiStatus.textContent = 'AI Enabled';
            } else {
                genaiStatus.className = 'badge bg-warning text-dark';
                genaiStatus.textContent = 'Demo Mode';
            }
        })
        .catch(() => {
            genaiStatus.className = 'badge bg-danger';
            genaiStatus.textContent = 'Error';
        });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatMessage(text) {
        // First escape HTML
        let escaped = escapeHtml(text);
        
        // Convert **text** to bold
        escaped = escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        
        // Convert numbered lists
        const lines = escaped.split('\n');
        let inOl = false;
        let inUl = false;
        let result = [];
        
        for (let line of lines) {
            const numberedMatch = line.match(/^(\d+)\.\s+(.*)$/);
            const bulletMatch = line.match(/^[-*]\s+(.*)$/);
            
            if (numberedMatch) {
                if (!inOl) {
                    if (inUl) { result.push('</ul>'); inUl = false; }
                    result.push('<ol>');
                    inOl = true;
                }
                result.push(`<li>${numberedMatch[2]}</li>`);
            } else if (bulletMatch) {
                if (!inUl) {
                    if (inOl) { result.push('</ol>'); inOl = false; }
                    result.push('<ul>');
                    inUl = true;
                }
                result.push(`<li>${bulletMatch[1]}</li>`);
            } else {
                if (inOl) { result.push('</ol>'); inOl = false; }
                if (inUl) { result.push('</ul>'); inUl = false; }
                result.push(line);
            }
        }
        
        if (inOl) result.push('</ol>');
        if (inUl) result.push('</ul>');
        
        return result.join('\n').replace(/\n/g, '<br>');
    }

    function addMessage(content, role) {
        // Remove the initial placeholder if it exists
        const placeholder = chatMessages.querySelector('.text-center.text-muted');
        if (placeholder) placeholder.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;
        
        if (role === 'assistant') {
            messageDiv.innerHTML = formatMessage(content);
        } else {
            messageDiv.textContent = content;
        }
        
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'chat-message assistant typing-indicator';
        indicator.id = 'typing-indicator';
        indicator.innerHTML = '<span></span><span></span><span></span>';
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    async function sendMessage(message) {
        if (!message.trim()) return;

        addMessage(message, 'user');
        conversationHistory.push({ role: 'user', content: message });
        
        chatInput.value = '';
        chatInput.disabled = true;
        sendBtn.disabled = true;
        addTypingIndicator();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    history: conversationHistory.slice(-10) // Keep last 10 messages for context
                })
            });

            const data = await response.json();
            removeTypingIndicator();

            if (data.success) {
                addMessage(data.message, 'assistant');
                conversationHistory.push({ role: 'assistant', content: data.message });
            } else {
                addMessage('Sorry, there was an error: ' + (data.error || 'Unknown error'), 'assistant');
            }
        } catch (error) {
            removeTypingIndicator();
            addMessage('Sorry, there was a network error. Please try again.', 'assistant');
        } finally {
            chatInput.disabled = false;
            sendBtn.disabled = false;
            chatInput.focus();
        }
    }

    chatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        sendMessage(chatInput.value);
    });

    document.querySelectorAll('.example-query').forEach(btn => {
        btn.addEventListener('click', () => {
            const query = btn.getAttribute('data-query');
            sendMessage(query);
        });
    });
</script>
}
